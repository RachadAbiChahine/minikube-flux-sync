---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: influxdb
  namespace: monitoring
spec:
  releaseName: influxdb
  chart:
    repository: https://helm.influxdata.com/
    name: influxdb
    version: 4.8.2
    paths: influxdata
  values:

    serviceAccount:
      create: true
      name:
      annotations: {}



    ## Persist data to a persistent volume
    ##
    persistence:
      enabled: false

    ## Deploy InfluxDB Enterprise - License required
    ## ref: https://www.influxdata.com/products/influxdb-enterprise/
    enterprise:
      enabled: false

    setDefaultUser:
      enabled: false

      ## Image of the container used for job
      ## Default: appropriate/curl:latest
      ##
      image: appropriate/curl:latest

      ## Deadline for job so it does not retry forever.
      ## Default: activeDeadline: 300
      ##
      activeDeadline: 300

      ## Specify the number of retries before considering job as failed.
      ## https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/#pod-backoff-failure-policy
      ##
      backoffLimit: 6

      ## Hook delete policy for helm.
      ## Default: hookDeletePolicy: hook-succeeded
      ##
      hookDeletePolicy: hook-succeeded

      ## Restart policy for job
      ## Default: OnFailure
      restartPolicy: OnFailure

      user:

        ## The user name
        ## Default: "admin"
        username: "minikube"

        ## User password
        ## single quotes must be escaped (\')
        ## Default: (Randomly generated 10 characters of AlphaNum)
        password: "minikube"

        ## The user name and password are obtained from an existing secret. The expected
        ## keys are `influxdb-user` and `influxdb-password`.
        ## If set, the username and password values above are ignored.
        # existingSecret: influxdb-auth

        ## User privileges
        ## Default: "WITH ALL PRIVILEGES"
        privileges: "WITH ALL PRIVILEGES"

    ## Configure resource requests and limits
    ## ref: http://kubernetes.io/docs/user-guide/compute-resources/
    resources: {}
    #  requests:
    #    memory: 256Mi
    #    cpu: 0.1
    #  limits:
    #    memory: 16Gi
    #    cpu: 8

    # Annotations to be added to InfluxDB pods
    podAnnotations: {}

    ingress:
      enabled: true
      tls: false
      # secretName: my-tls-cert # only needed if tls above is true
      hostname: influxdb.minikube.local
      annotations:
      # kubernetes.io/ingress.class: "nginx"
      # kubernetes.io/tls-acme: "true"


    env:
     - name: INFLUXDB_DB
       value: "demo"

    ## InfluxDB configuration
    ## ref: https://docs.influxdata.com/influxdb/v1.7/administration/config
    config:
      reporting_disabled: false
      rpc: {}
      meta: {}
      data: {}
      coordinator: {}
      retention: {}
      shard_precreation: {}
      monitor: {}
      http: {}
      logging: {}
      subscriber: {}
      graphite: {}
      collectd: {}
      opentsdb: {}
      udp: {}
      continuous_queries: {}
      tls: {}

    # Allow executing custom init scripts
    #
    # If the container finds any files with the extensions .sh or .iql inside of the
    # /docker-entrypoint-initdb.d folder, it will execute them. The order they are
    # executed in is determined by the shell. This is usually alphabetical order.
    initScripts:
      enabled: false
      scripts:
        init.iql: |+
          CREATE DATABASE "minikube" WITH DURATION 30d REPLICATION 1 NAME "rp_30d"

